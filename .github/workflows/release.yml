#############################################################################
# PixlPunkt - Release Workflow (Uno Platform)
#############################################################################
# Creates a GitHub release with builds for multiple platforms using Uno.
# Triggered manually or on version tags (v*).
#
# Platforms:
# - Windows (WinAppSdk MSIX) - x64, arm64
# - Windows Desktop (Skia) - x64
# - Linux Desktop (Skia) - x64 (tar.gz + DEB + RPM)
# - macOS Desktop (Skia) - x64, arm64 (ZIP + DMG)
# - Plugin SDK (NuGet)
#
# Versioning:
# - Tag push (v1.0.0): MinVer automatically uses 1.0.0
# - Manual dispatch: Overrides version with input value
#############################################################################

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0) - overrides MinVer'
        required: true
      prerelease:
        description: 'Is this a pre-release?'
        type: boolean
        default: false

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  UNO_PROJECT_PATH: 'PixlPunkt.Uno/PixlPunkt.Uno/PixlPunkt.Uno.csproj'

jobs:
  #############################################################################
  # Build SDK
  #############################################################################
  build-sdk:
    name: Build Plugin SDK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for MinVer

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "version_args=-p:Version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "version_args=" >> $GITHUB_OUTPUT
          fi

      - name: Build and pack SDK
        run: |
          dotnet pack PixlPunkt.PluginSdk/PixlPunkt.PluginSdk.csproj \
            --configuration Release \
            --output ./artifacts \
            ${{ steps.version.outputs.version_args }}

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-package
          path: ./artifacts/*.nupkg

  #############################################################################
  # Build WinAppSdk (Windows MSIX)
  #############################################################################
  build-winappsdk:
    name: Build WinAppSdk (${{ matrix.platform }})
    runs-on: windows-latest
    
    strategy:
      fail-fast: false
      matrix:
        platform: [x64, arm64]
        include:
          - platform: x64
            rid: win-x64
          - platform: arm64
            rid: win-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Decode and import signing certificate
        id: cert
        shell: pwsh
        env:
          CERT_BASE64: ${{ secrets.SIGNING_CERTIFICATE_BASE64 }}
          CERT_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          if (-not $env:CERT_BASE64) {
            $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=PixlPunkt Dev" -KeyUsage DigitalSignature -FriendlyName "PixlPunkt Dev" -CertStoreLocation "Cert:\CurrentUser\My" -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
            $thumbprint = $cert.Thumbprint
          } else {
            $pfxBytes = [Convert]::FromBase64String($env:CERT_BASE64)
            $pfxPath = Join-Path $env:RUNNER_TEMP "PixlPunkt.pfx"
            [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
            $securePassword = ConvertTo-SecureString -String $env:CERT_PASSWORD -AsPlainText -Force
            $cert = Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $securePassword
            $thumbprint = $cert.Thumbprint
            $cerPath = Join-Path $env:RUNNER_TEMP "PixlPunkt.cer"
            Export-Certificate -Cert $cert -FilePath $cerPath -Type CERT | Out-Null
            echo "CERT_CER_PATH=$cerPath" >> $env:GITHUB_ENV
          }
          echo "CERT_THUMBPRINT=$thumbprint" >> $env:GITHUB_ENV

      - name: Build WinAppSdk MSIX
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $thumbprint = $env:CERT_THUMBPRINT
          $versionParts = $version -split '\.'
          while ($versionParts.Count -lt 4) { $versionParts += "0" }
          $msixVersion = $versionParts[0..3] -join '.'
          
          dotnet publish $env:UNO_PROJECT_PATH `
            --configuration Release `
            --framework net10.0-windows10.0.26100 `
            --runtime ${{ matrix.rid }} `
            --self-contained true `
            -p:Platform=${{ matrix.platform }} `
            -p:Version=$msixVersion `
            -p:GenerateAppxPackageOnBuild=true `
            -p:AppxPackageSigningEnabled=true `
            -p:PackageCertificateThumbprint=$thumbprint `
            -p:AppxBundle=Never `
            -p:UapAppxPackageBuildMode=SideloadOnly `
            -p:AppxPackageDir=../../artifacts/winappsdk-${{ matrix.platform }}/ `
            -p:WindowsAppSDKSelfContained=true

      - name: Prepare release package
        id: prepare
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $platform = "${{ matrix.platform }}"
          $outputDir = "release-winappsdk-$platform"
          New-Item -ItemType Directory -Path $outputDir -Force
          
          $msixFiles = Get-ChildItem -Path "artifacts/winappsdk-$platform" -Filter "*.msix" -Recurse |
                       Where-Object { $_.Name -notlike "*Dependencies*" }
          $msixFile = $msixFiles | Select-Object -First 1
          Copy-Item $msixFile.FullName -Destination "$outputDir/PixlPunkt-$version-WinAppSdk-$platform.msix"
          
          $cerPath = $env:CERT_CER_PATH
          if ($cerPath -and (Test-Path $cerPath)) {
            Copy-Item $cerPath -Destination "$outputDir/PixlPunkt.cer"
          }
          
          Set-Content -Path "$outputDir/Install-PixlPunkt.ps1" -Value @'
          #Requires -RunAsAdministrator
          $certPath = Join-Path $PSScriptRoot "PixlPunkt.cer"
          if (Test-Path $certPath) { Import-Certificate -FilePath $certPath -CertStoreLocation Cert:\LocalMachine\TrustedPeople | Out-Null }
          $msixPath = Get-ChildItem -Path $PSScriptRoot -Filter "*.msix" | Select-Object -First 1
          if ($msixPath) { Add-AppxPackage -Path $msixPath.FullName }
          '@
          
          $zipName = "PixlPunkt-$version-WinAppSdk-$platform.zip"
          Compress-Archive -Path "$outputDir/*" -DestinationPath $zipName
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: winappsdk-${{ matrix.platform }}
          path: ${{ steps.prepare.outputs.zip_name }}

  #############################################################################
  # Build Desktop Windows (Skia) - with Velopack Installer
  #############################################################################
  build-desktop-windows:
    name: Build Desktop Windows (x64)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Velopack
        shell: pwsh
        run: dotnet tool install -g vpk

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Build Desktop Windows
        shell: pwsh
        run: |
          dotnet publish ${{ env.UNO_PROJECT_PATH }} `
            --configuration Release `
            --framework net10.0-desktop `
            --runtime win-x64 `
            --self-contained true `
            --output ./publish/desktop-windows-x64 `
            -p:Version=${{ steps.version.outputs.version }} `
            -p:PublishSingleFile=false `
            -p:PublishReadyToRun=true

      - name: Create Velopack Release
        id: velopack
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $publishDir = "./publish/desktop-windows-x64"
          $releaseDir = "./releases"
          
          # Create releases directory
          New-Item -ItemType Directory -Path $releaseDir -Force
          
          # Get icon path (use .ico if available, otherwise skip)
          $iconArg = ""
          if (Test-Path "PixlPunkt.Uno/PixlPunkt.Uno/Assets/Icons/PixlPunkt.ico") {
            $iconArg = "--icon `"PixlPunkt.Uno/PixlPunkt.Uno/Assets/Icons/PixlPunkt.ico`""
          }
          
          # Pack with Velopack
          # Uses GitHub releases as update source
          $vpkArgs = @(
            "pack",
            "--packId", "PixlPunkt",
            "--packVersion", "$version",
            "--packDir", "$publishDir",
            "--mainExe", "PixlPunkt.Uno.exe",
            "--outputDir", "$releaseDir",
            "--packTitle", "PixlPunkt",
            "--packAuthors", "PixlPunkt"
          )
          
          if (Test-Path "PixlPunkt.Uno/PixlPunkt.Uno/Assets/Icons/PixlPunkt.ico") {
            $vpkArgs += "--icon"
            $vpkArgs += "PixlPunkt.Uno/PixlPunkt.Uno/Assets/Icons/PixlPunkt.ico"
          }
          
          & vpk @vpkArgs
          
          # Find the generated files
          $setupExe = Get-ChildItem -Path $releaseDir -Filter "*Setup.exe" | Select-Object -First 1
          
          # Rename setup for clarity
          $setupName = "PixlPunkt-$version-Windows-Setup.exe"
          if ($setupExe) {
            Copy-Item $setupExe.FullName -Destination "$releaseDir/$setupName"
            echo "setup_name=$setupName" >> $env:GITHUB_OUTPUT
            echo "has_setup=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "has_setup=false" >> $env:GITHUB_OUTPUT
            Write-Host "Warning: Setup.exe not found"
            Get-ChildItem -Path $releaseDir -Recurse | ForEach-Object { Write-Host $_.FullName }
          }
          
          # Also create portable ZIP
          $zipName = "PixlPunkt-$version-Desktop-Windows-x64-Portable.zip"
          Compress-Archive -Path "$publishDir/*" -DestinationPath "$releaseDir/$zipName"
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
          echo "release_dir=$releaseDir" >> $env:GITHUB_OUTPUT

      - name: Upload Setup installer
        if: steps.velopack.outputs.has_setup == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows-setup
          path: ${{ steps.velopack.outputs.release_dir }}/${{ steps.velopack.outputs.setup_name }}

      - name: Upload Portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows-x64
          path: ${{ steps.velopack.outputs.release_dir }}/${{ steps.velopack.outputs.zip_name }}

      - name: Upload Velopack releases (for auto-update)
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows-velopack
          path: |
            ${{ steps.velopack.outputs.release_dir }}/*.nupkg
            ${{ steps.velopack.outputs.release_dir }}/RELEASES
          if-no-files-found: ignore

  #############################################################################
  # Build Desktop Linux (Skia) - with DEB and RPM
  #############################################################################
  build-desktop-linux:
    name: Build Desktop Linux (x64)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libgl1-mesa-dev
          # Install fpm for DEB/RPM packaging
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Build Desktop Linux
        run: |
          dotnet publish ${{ env.UNO_PROJECT_PATH }} \
            --configuration Release \
            --framework net10.0-desktop \
            --runtime linux-x64 \
            --self-contained true \
            --output ./publish/desktop-linux-x64 \
            -p:Version=${{ steps.version.outputs.version }} \
            -p:PublishSingleFile=false \
            -p:PublishReadyToRun=true

      - name: Prepare package structure
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          chmod +x ./publish/desktop-linux-x64/PixlPunkt.Uno
          
          mkdir -p ./pkg-root/opt/pixlpunkt
          mkdir -p ./pkg-root/usr/share/applications
          mkdir -p ./pkg-root/usr/share/mime/packages
          mkdir -p ./pkg-root/usr/share/icons/hicolor/256x256/apps
          
          cp -r ./publish/desktop-linux-x64/* ./pkg-root/opt/pixlpunkt/
          
          cat > ./pkg-root/usr/share/applications/com.pixlpunkt.app.desktop << EOF
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=PixlPunkt
          Comment=Pixel Art Editor
          Exec=/opt/pixlpunkt/PixlPunkt.Uno %F
          Icon=pixlpunkt
          Terminal=false
          Categories=Graphics;2DGraphics;RasterGraphics;
          MimeType=application/x-pixlpunkt;application/x-pixlpunkt-reel;application/x-pixlpunkt-tileset;application/x-pixlpunkt-brush;
          EOF
          
          cat > ./pkg-root/usr/share/mime/packages/com.pixlpunkt.app.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
              <mime-type type="application/x-pixlpunkt"><comment>PixlPunkt Document</comment><glob pattern="*.pxp"/></mime-type>
              <mime-type type="application/x-pixlpunkt-reel"><comment>PixlPunkt Animation Reel</comment><glob pattern="*.pxpr"/></mime-type>
              <mime-type type="application/x-pixlpunkt-tileset"><comment>PixlPunkt Tileset</comment><glob pattern="*.pxpt"/></mime-type>
              <mime-type type="application/x-pixlpunkt-brush"><comment>PixlPunkt Brush</comment><glob pattern="*.pbx"/></mime-type>
          </mime-info>
          EOF
          
          if [ -f "PixlPunkt.Uno/PixlPunkt.Uno/Assets/Icons/Icon.png" ]; then
            cp "PixlPunkt.Uno/PixlPunkt.Uno/Assets/Icons/Icon.png" ./pkg-root/usr/share/icons/hicolor/256x256/apps/pixlpunkt.png
          fi

      - name: Create DEB package
        id: deb
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DEB_NAME="pixlpunkt_${VERSION}_amd64.deb"
          
          cat > /tmp/after-install.sh << 'EOF'
          update-mime-database /usr/share/mime 2>/dev/null || true
          update-desktop-database /usr/share/applications 2>/dev/null || true
          ln -sf /opt/pixlpunkt/PixlPunkt.Uno /usr/local/bin/pixlpunkt
          EOF
          
          cat > /tmp/after-remove.sh << 'EOF'
          rm -f /usr/local/bin/pixlpunkt
          update-mime-database /usr/share/mime 2>/dev/null || true
          update-desktop-database /usr/share/applications 2>/dev/null || true
          EOF
          
          fpm -s dir -t deb \
            --name pixlpunkt \
            --version "$VERSION" \
            --architecture amd64 \
            --description "PixlPunkt - Modern Pixel Art Editor" \
            --url "https://github.com/ChadRoesler/PixlPunkt" \
            --license "MIT" \
            --depends "libx11-6" --depends "libxrandr2" --depends "libxinerama1" --depends "libxcursor1" --depends "libxi6" --depends "libgl1" \
            --after-install /tmp/after-install.sh \
            --after-remove /tmp/after-remove.sh \
            --package "$DEB_NAME" \
            -C ./pkg-root opt usr
          
          echo "deb_name=$DEB_NAME" >> $GITHUB_OUTPUT

      - name: Create RPM package
        id: rpm
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RPM_NAME="pixlpunkt-${VERSION}-1.x86_64.rpm"
          
          fpm -s dir -t rpm \
            --name pixlpunkt \
            --version "$VERSION" \
            --architecture x86_64 \
            --description "PixlPunkt - Modern Pixel Art Editor" \
            --url "https://github.com/ChadRoesler/PixlPunkt" \
            --license "MIT" \
            --depends "libX11" --depends "libXrandr" --depends "libXinerama" --depends "libXcursor" --depends "libXi" --depends "mesa-libGL" \
            --after-install /tmp/after-install.sh \
            --after-remove /tmp/after-remove.sh \
            --package "$RPM_NAME" \
            -C ./pkg-root opt usr
          
          echo "rpm_name=$RPM_NAME" >> $GITHUB_OUTPUT

      - name: Create tarball
        id: tar
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAR_NAME="PixlPunkt-$VERSION-Desktop-Linux-x64.tar.gz"
          
          if [ -f "PixlPunkt.Uno/Installers/Linux/install.sh" ]; then
            cp PixlPunkt.Uno/Installers/Linux/install.sh ./publish/desktop-linux-x64/
            cp PixlPunkt.Uno/Installers/Linux/uninstall.sh ./publish/desktop-linux-x64/
            chmod +x ./publish/desktop-linux-x64/*.sh
          fi
          
          cd ./publish && tar -czvf ../$TAR_NAME desktop-linux-x64 && cd ..
          echo "tar_name=$TAR_NAME" >> $GITHUB_OUTPUT

      - name: Upload tarball
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux-x64
          path: ${{ steps.tar.outputs.tar_name }}

      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux-deb
          path: ${{ steps.deb.outputs.deb_name }}

      - name: Upload RPM
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux-rpm
          path: ${{ steps.rpm.outputs.rpm_name }}

  #############################################################################
  # Build Desktop macOS (Skia) - with DMG
  #############################################################################
  build-desktop-macos:
    name: Build Desktop macOS (${{ matrix.arch }})
    runs-on: macos-latest
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
        include:
          - arch: x64
            rid: osx-x64
          - arch: arm64
            rid: osx-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Build Desktop macOS
        run: |
          dotnet publish ${{ env.UNO_PROJECT_PATH }} \
            --configuration Release \
            --framework net10.0-desktop \
            --runtime ${{ matrix.rid }} \
            --self-contained true \
            --output ./publish/desktop-macos-${{ matrix.arch }} \
            -p:Version=${{ steps.version.outputs.version }} \
            -p:PublishSingleFile=false \
            -p:PublishReadyToRun=true

      - name: Create macOS App Bundle
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          
          APP_BUNDLE="./PixlPunkt.app"
          mkdir -p "$APP_BUNDLE/Contents/MacOS"
          mkdir -p "$APP_BUNDLE/Contents/Resources"
          
          cp -r ./publish/desktop-macos-$ARCH/* "$APP_BUNDLE/Contents/MacOS/"
          chmod +x "$APP_BUNDLE/Contents/MacOS/PixlPunkt.Uno"
          
          if [ -f "PixlPunkt.Uno/PixlPunkt.Uno/Assets/Icons/Icon.png" ]; then
            cp "PixlPunkt.Uno/PixlPunkt.Uno/Assets/Icons/Icon.png" "$APP_BUNDLE/Contents/Resources/AppIcon.png"
          fi
          
          cat > "$APP_BUNDLE/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key><string>PixlPunkt.Uno</string>
              <key>CFBundleIdentifier</key><string>com.pixlpunkt.app</string>
              <key>CFBundleName</key><string>PixlPunkt</string>
              <key>CFBundlePackageType</key><string>APPL</string>
              <key>CFBundleShortVersionString</key><string>$VERSION</string>
              <key>LSMinimumSystemVersion</key><string>10.15</string>
              <key>NSHighResolutionCapable</key><true/>
              <key>CFBundleDocumentTypes</key>
              <array>
                  <dict><key>CFBundleTypeName</key><string>PixlPunkt Document</string><key>CFBundleTypeRole</key><string>Editor</string><key>LSHandlerRank</key><string>Owner</string><key>CFBundleTypeExtensions</key><array><string>pxp</string></array></dict>
                  <dict><key>CFBundleTypeName</key><string>PixlPunkt Reel</string><key>CFBundleTypeRole</key><string>Editor</string><key>LSHandlerRank</key><string>Owner</string><key>CFBundleTypeExtensions</key><array><string>pxpr</string></array></dict>
                  <dict><key>CFBundleTypeName</key><string>PixlPunkt Tileset</string><key>CFBundleTypeRole</key><string>Editor</string><key>LSHandlerRank</key><string>Owner</string><key>CFBundleTypeExtensions</key><array><string>pxpt</string></array></dict>
                  <dict><key>CFBundleTypeName</key><string>PixlPunkt Brush</string><key>CFBundleTypeRole</key><string>Editor</string><key>LSHandlerRank</key><string>Owner</string><key>CFBundleTypeExtensions</key><array><string>pbx</string></array></dict>
              </array>
          </dict>
          </plist>
          EOF

      - name: Create DMG
        id: dmg
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          DMG_NAME="PixlPunkt-$VERSION-macOS-$ARCH.dmg"
          
          create-dmg --volname "PixlPunkt $VERSION" --window-pos 200 120 --window-size 600 400 --icon-size 100 --icon "PixlPunkt.app" 150 185 --hide-extension "PixlPunkt.app" --app-drop-link 450 185 "$DMG_NAME" "./PixlPunkt.app" || true
          
          if [ -f "$DMG_NAME" ]; then
            echo "dmg_name=$DMG_NAME" >> $GITHUB_OUTPUT
            echo "has_dmg=true" >> $GITHUB_OUTPUT
          else
            echo "has_dmg=false" >> $GITHUB_OUTPUT
          fi

      - name: Create ZIP
        id: zip
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          ZIP_NAME="PixlPunkt-$VERSION-Desktop-macOS-$ARCH.zip"
          zip -r "$ZIP_NAME" PixlPunkt.app
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Upload DMG
        if: steps.dmg.outputs.has_dmg == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos-dmg-${{ matrix.arch }}
          path: ${{ steps.dmg.outputs.dmg_name }}

      - name: Upload ZIP
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos-${{ matrix.arch }}
          path: ${{ steps.zip.outputs.zip_name }}

  #############################################################################
  # Create Release
  #############################################################################
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-sdk, build-winappsdk, build-desktop-windows, build-desktop-linux, build-desktop-macos]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-artifacts

      - name: List artifacts
        run: ls -R ./release-artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: PixlPunkt ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          generate_release_notes: true
          body: |
            ## Downloads
            
            ### Windows
            | Package | Description | Download |
            |---------|-------------|----------|
            | **Setup Installer (x64)** | Recommended - includes auto-updates | `PixlPunkt-${{ steps.version.outputs.version }}-Windows-Setup.exe` |
            | WinAppSdk MSIX (x64) | Windows Store style package | `PixlPunkt-${{ steps.version.outputs.version }}-WinAppSdk-x64.zip` |
            | WinAppSdk MSIX (ARM64) | For ARM Windows devices | `PixlPunkt-${{ steps.version.outputs.version }}-WinAppSdk-arm64.zip` |
            | Portable ZIP (x64) | No install required | `PixlPunkt-${{ steps.version.outputs.version }}-Desktop-Windows-x64-Portable.zip` |
            
            ### Linux
            | Package | Description | Download |
            |---------|-------------|----------|
            | **DEB (Debian/Ubuntu)** | For apt-based distros | `pixlpunkt_${{ steps.version.outputs.version }}_amd64.deb` |
            | **RPM (Fedora/RHEL)** | For dnf/yum-based distros | `pixlpunkt-${{ steps.version.outputs.version }}-1.x86_64.rpm` |
            | Portable tarball | Universal Linux | `PixlPunkt-${{ steps.version.outputs.version }}-Desktop-Linux-x64.tar.gz` |
            
            ### macOS
            | Package | Description | Download |
            |---------|-------------|----------|
            | **DMG (Intel)** | For Intel Macs | `PixlPunkt-${{ steps.version.outputs.version }}-macOS-x64.dmg` |
            | **DMG (Apple Silicon)** | For M1/M2/M3 Macs | `PixlPunkt-${{ steps.version.outputs.version }}-macOS-arm64.dmg` |
            | ZIP (Intel) | Portable for Intel | `PixlPunkt-${{ steps.version.outputs.version }}-Desktop-macOS-x64.zip` |
            | ZIP (Apple Silicon) | Portable for M1/M2/M3 | `PixlPunkt-${{ steps.version.outputs.version }}-Desktop-macOS-arm64.zip` |
            
            ### Plugin SDK
            | Package | Download |
            |---------|----------|
            | NuGet | `PixlPunkt.PluginSdk.${{ steps.version.outputs.version }}.nupkg` |
            
            ---
            
            ## Installation
            
            ### Windows (Recommended)
            1. Download `PixlPunkt-${{ steps.version.outputs.version }}-Windows-Setup.exe`
            2. Run the installer - no admin rights needed!
            3. App will auto-update when new versions are available
            
            ### Windows (MSIX)
            1. Extract the ZIP
            2. Run `Install-PixlPunkt.ps1` as Administrator
            
            ### Linux (DEB)
            ```bash
            sudo dpkg -i pixlpunkt_${{ steps.version.outputs.version }}_amd64.deb
            sudo apt-get install -f  # Install dependencies if needed
            ```
            
            ### Linux (RPM)
            ```bash
            sudo dnf install pixlpunkt-${{ steps.version.outputs.version }}-1.x86_64.rpm
            ```
            
            ### macOS
            1. Download the DMG for your processor
            2. Open the DMG and drag PixlPunkt to Applications
            3. Allow the app in System Settings > Privacy & Security if prompted
            
          files: |
            ./release-artifacts/desktop-windows-setup/*.exe
            ./release-artifacts/winappsdk-x64/*.zip
            ./release-artifacts/winappsdk-arm64/*.zip
            ./release-artifacts/desktop-windows-x64/*.zip
            ./release-artifacts/desktop-windows-velopack/*.nupkg
            ./release-artifacts/desktop-windows-velopack/RELEASES
            ./release-artifacts/desktop-linux-x64/*.tar.gz
            ./release-artifacts/desktop-linux-deb/*.deb
            ./release-artifacts/desktop-linux-rpm/*.rpm
            ./release-artifacts/desktop-macos-x64/*.zip
            ./release-artifacts/desktop-macos-arm64/*.zip
            ./release-artifacts/desktop-macos-dmg-x64/*.dmg
            ./release-artifacts/desktop-macos-dmg-arm64/*.dmg
            ./release-artifacts/sdk-package/*.nupkg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
