#############################################################################
# PixlPunkt.Uno - WinAppSdk Build Workflow
#############################################################################
# Builds the Uno Platform app as a WinAppSdk MSIX package.
# Runs unit tests before building to ensure code quality.
# Triggered on pushes to main/master and pull requests affecting Uno files.
#############################################################################

name: Build Uno WinAppSdk

on:
  push:
    branches: [main, master, unoSkiaSharp]
    paths:
      - 'PixlPunkt.Uno/**'
      - 'PixlPunkt.PluginSdk/**'
      - '.github/workflows/build-uno-winappsdk.yml'
  pull_request:
    branches: [main, master, unoSkiaSharp]
    paths:
      - 'PixlPunkt.Uno/**'
      - 'PixlPunkt.PluginSdk/**'
      - '.github/workflows/build-uno-winappsdk.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  UNO_PROJECT_PATH: 'PixlPunkt.Uno/PixlPunkt.Uno/PixlPunkt.Uno.csproj'

jobs:
  #############################################################################
  # Run Tests First
  #############################################################################
  run-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run SDK Tests
        run: |
          echo "Running PluginSdk Tests..."
          dotnet test PixlPunkt.PluginSdk.Tests/PixlPunkt.PluginSdk.Tests.csproj \
            --configuration Release \
            --verbosity normal \
            --logger "trx;LogFileName=sdk-test-results.trx"

      - name: Run Uno Tests
        run: |
          echo "Running Uno Tests..."
          dotnet test PixlPunkt.Uno/PixlPunkt.Uno.Tests/PixlPunkt.Uno.Tests.csproj \
            --configuration Release \
            --verbosity normal \
            --logger "trx;LogFileName=uno-test-results.trx"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            PixlPunkt.PluginSdk.Tests/TestResults/*.trx
            PixlPunkt.Uno/PixlPunkt.Uno.Tests/TestResults/*.trx
          retention-days: 30
          if-no-files-found: ignore

  #############################################################################
  # Build WinAppSdk MSIX
  #############################################################################
  build-winappsdk:
    name: Build WinAppSdk (${{ matrix.platform }})
    runs-on: windows-latest
    needs: run-tests
    
    strategy:
      fail-fast: false
      matrix:
        platform: [x64, arm64]
        include:
          - platform: x64
            rid: win-x64
          - platform: arm64
            rid: win-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Decode and import signing certificate
        id: cert
        if: github.event_name != 'pull_request'
        shell: pwsh
        env:
          CERT_BASE64: ${{ secrets.SIGNING_CERTIFICATE_BASE64 }}
          CERT_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          if ($env:CERT_BASE64) {
            $pfxBytes = [Convert]::FromBase64String($env:CERT_BASE64)
            $pfxPath = Join-Path $env:RUNNER_TEMP "PixlPunkt.pfx"
            [IO.File]::WriteAllBytes($pfxPath, $pfxBytes)
            
            $securePassword = ConvertTo-SecureString -String $env:CERT_PASSWORD -AsPlainText -Force
            $cert = Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\CurrentUser\My -Password $securePassword
            $thumbprint = $cert.Thumbprint
            
            $cerPath = Join-Path $env:RUNNER_TEMP "PixlPunkt.cer"
            Export-Certificate -Cert $cert -FilePath $cerPath -Type CERT | Out-Null
            
            echo "CERT_THUMBPRINT=$thumbprint" >> $env:GITHUB_ENV
            echo "CERT_CER_PATH=$cerPath" >> $env:GITHUB_ENV
            echo "HAS_CERT=true" >> $env:GITHUB_ENV
            Write-Host "Certificate imported with thumbprint: $thumbprint"
          } else {
            Write-Host "No signing certificate configured, will create self-signed" -ForegroundColor Yellow
            $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=PixlPunkt Dev" -KeyUsage DigitalSignature -FriendlyName "PixlPunkt Dev" -CertStoreLocation "Cert:\CurrentUser\My" -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
            $thumbprint = $cert.Thumbprint
            echo "CERT_THUMBPRINT=$thumbprint" >> $env:GITHUB_ENV
            echo "HAS_CERT=true" >> $env:GITHUB_ENV
          }

      - name: Restore dependencies
        run: |
          dotnet restore ${{ env.UNO_PROJECT_PATH }} -r ${{ matrix.rid }}

      - name: Build WinAppSdk MSIX
        shell: pwsh
        run: |
          $hasCert = $env:HAS_CERT -eq "true"
          $thumbprint = $env:CERT_THUMBPRINT
          
          Write-Host "Building WinAppSdk MSIX..." -ForegroundColor Cyan
          Write-Host "  Platform: ${{ matrix.platform }}" -ForegroundColor Gray
          Write-Host "  Has Certificate: $hasCert" -ForegroundColor Gray
          
          $buildArgs = @(
            "publish", "${{ env.UNO_PROJECT_PATH }}",
            "--configuration", "Release",
            "--framework", "net10.0-windows10.0.26100",
            "--runtime", "${{ matrix.rid }}",
            "--self-contained", "true",
            "-p:Platform=${{ matrix.platform }}",
            "-p:GenerateAppxPackageOnBuild=true",
            "-p:AppxBundle=Never",
            "-p:UapAppxPackageBuildMode=SideloadOnly",
            "-p:AppxPackageDir=../../artifacts/winappsdk-${{ matrix.platform }}/",
            "-p:WindowsAppSDKSelfContained=true"
          )
          
          if ($hasCert -and $thumbprint) {
            $buildArgs += "-p:AppxPackageSigningEnabled=true"
            $buildArgs += "-p:PackageCertificateThumbprint=$thumbprint"
          } else {
            $buildArgs += "-p:AppxPackageSigningEnabled=false"
          }
          
          & dotnet @buildArgs
          
          Write-Host "Build output:" -ForegroundColor Yellow
          Get-ChildItem -Path "artifacts/winappsdk-${{ matrix.platform }}" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { 
            Write-Host "  $($_.FullName)" 
          }

      - name: Prepare artifacts
        id: prepare
        shell: pwsh
        run: |
          $platform = "${{ matrix.platform }}"
          $outputDir = "release-winappsdk-$platform"
          
          New-Item -ItemType Directory -Path $outputDir -Force
          
          # Find MSIX
          $msixFiles = Get-ChildItem -Path "artifacts/winappsdk-$platform" -Filter "*.msix" -Recurse -ErrorAction SilentlyContinue |
                       Where-Object { $_.Name -notlike "*Dependencies*" }
          
          if ($msixFiles -and $msixFiles.Count -gt 0) {
            $msixFile = $msixFiles | Select-Object -First 1
            Copy-Item $msixFile.FullName -Destination "$outputDir/PixlPunkt-WinAppSdk-$platform.msix"
            
            # Copy certificate if available
            $cerPath = $env:CERT_CER_PATH
            if ($cerPath -and (Test-Path $cerPath)) {
              Copy-Item $cerPath -Destination "$outputDir/PixlPunkt.cer"
            }
            
            # Create install script
            Set-Content -Path "$outputDir/Install-PixlPunkt.ps1" -Value @'
            #Requires -RunAsAdministrator
            $ErrorActionPreference = "Stop"
            Write-Host "PixlPunkt WinAppSdk Installer" -ForegroundColor Cyan

            $certPath = Join-Path $PSScriptRoot "PixlPunkt.cer"
            if (Test-Path $certPath) {
                Write-Host "Installing certificate..." -ForegroundColor Yellow
                Import-Certificate -FilePath $certPath -CertStoreLocation Cert:\LocalMachine\TrustedPeople | Out-Null
            }

            $msixPath = Get-ChildItem -Path $PSScriptRoot -Filter "*.msix" | Select-Object -First 1
            if ($msixPath) {
                Write-Host "Installing PixlPunkt..." -ForegroundColor Yellow
                Add-AppxPackage -Path $msixPath.FullName
                Write-Host "Done! Launch from Start Menu." -ForegroundColor Green
            }
            Read-Host "Press Enter to exit"
            '@
            
            # Create ZIP
            $zipName = "PixlPunkt-WinAppSdk-$platform.zip"
            Compress-Archive -Path "$outputDir/*" -DestinationPath $zipName
            echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
            echo "has_artifact=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Warning: No MSIX package found" -ForegroundColor Yellow
            echo "has_artifact=false" >> $env:GITHUB_OUTPUT
          }

      - name: Upload artifact
        if: steps.prepare.outputs.has_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: PixlPunkt-WinAppSdk-${{ matrix.platform }}
          path: ${{ steps.prepare.outputs.zip_name }}
          retention-days: 30

  combine-artifacts:
    name: Combine Artifacts
    runs-on: ubuntu-latest
    needs: [run-tests, build-winappsdk]
    if: success()

    steps:
      - name: Download x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: PixlPunkt-WinAppSdk-x64
          path: ./release
        continue-on-error: true

      - name: Download ARM64 artifact
        uses: actions/download-artifact@v4
        with:
          name: PixlPunkt-WinAppSdk-arm64
          path: ./release
        continue-on-error: true

      - name: List artifacts
        run: ls -R ./release || echo "No artifacts found"

      - name: Upload combined release
        uses: actions/upload-artifact@v4
        with:
          name: PixlPunkt-WinAppSdk-AllPlatforms
          path: ./release/
          retention-days: 30
          if-no-files-found: warn
