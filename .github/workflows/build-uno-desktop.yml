#############################################################################
# PixlPunkt.Uno - Desktop Build Workflow
#############################################################################
# Builds the Uno Platform app for all Desktop platforms:
# - Skia Desktop (Windows, Linux, macOS) - Cross-platform renderer
# - WinAppSdk (Windows only) - Native Windows UI
#
# Also runs unit tests before building to ensure code quality.
#
# Target Frameworks:
# - net10.0-desktop: Skia-based renderer for Windows, Linux, macOS
# - net10.0-windows10.0.26100: WinAppSdk for native Windows
#
# Uses project-level properties to exclude mobile targets:
# - SkiaOnly=true: Only builds net10.0-desktop
# - WinAppSdkOnly=true: Only builds net10.0-windows10.0.26100
# - DesktopOnly=true: Builds all desktop targets (no Android/iOS)
#############################################################################

name: Build Uno Desktop

on:
  push:
    branches: [main, master, unoSkiaSharp]
    paths:
      - 'PixlPunkt.Uno/**'
      - 'PixlPunkt.PluginSdk/**'
      - '.github/workflows/build-uno-desktop.yml'
  pull_request:
    branches: [main, master, unoSkiaSharp]
    paths:
      - 'PixlPunkt.Uno/**'
      - 'PixlPunkt.PluginSdk/**'
      - '.github/workflows/build-uno-desktop.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  UNO_PROJECT_PATH: 'PixlPunkt.Uno/PixlPunkt.Uno/PixlPunkt.Uno.csproj'

jobs:
  #############################################################################
  # Run Tests First
  #############################################################################
  run-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore SDK Tests
        run: dotnet restore PixlPunkt.PluginSdk.Tests/PixlPunkt.PluginSdk.Tests.csproj

      - name: Run SDK Tests
        run: |
          echo "Running PluginSdk Tests..."
          dotnet test PixlPunkt.PluginSdk.Tests/PixlPunkt.PluginSdk.Tests.csproj \
            --configuration Release \
            --verbosity normal \
            --logger "trx;LogFileName=sdk-test-results.trx"
      
      # Note: Uno Tests are run on Windows in the build-skia-windows job
      # because they require the Uno project which has multi-platform targets
      # that need workloads not available on Linux runners.

      - name: Upload SDK test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sdk-test-results
          path: PixlPunkt.PluginSdk.Tests/TestResults/*.trx
          retention-days: 30
          if-no-files-found: ignore

  #############################################################################
  # Build Skia Desktop - Windows (x64)
  #############################################################################
  build-skia-windows:
    name: Skia Desktop Windows (x64)
    runs-on: windows-latest
    needs: run-tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run Uno Tests
        shell: pwsh
        run: |
          Write-Host "Running Uno Tests on Windows..." -ForegroundColor Cyan
          dotnet test PixlPunkt.Uno/PixlPunkt.Uno.Tests/PixlPunkt.Uno.Tests.csproj `
            --configuration Release `
            --verbosity normal `
            --logger "trx;LogFileName=uno-test-results.trx"

      - name: Upload Uno test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: uno-test-results
          path: PixlPunkt.Uno/PixlPunkt.Uno.Tests/TestResults/*.trx
          retention-days: 30
          if-no-files-found: ignore

      - name: Build Skia Desktop Windows
        shell: pwsh
        run: |
          Write-Host "Building Skia Desktop Windows (x64)..." -ForegroundColor Cyan
          
          # Use SkiaOnly=true to avoid needing Android/iOS workloads
          dotnet publish ${{ env.UNO_PROJECT_PATH }} `
            --configuration Release `
            --framework net10.0-desktop `
            --runtime win-x64 `
            --self-contained true `
            --output ./publish/skia-windows-x64 `
            -p:SkiaOnly=true `
            -p:PublishSingleFile=false `
            -p:PublishReadyToRun=true

      - name: Prepare artifact
        id: prepare
        shell: pwsh
        run: |
          $zipName = "PixlPunkt-Skia-Windows-x64.zip"
          
          if (Test-Path "./publish/skia-windows-x64") {
            Compress-Archive -Path "./publish/skia-windows-x64/*" -DestinationPath $zipName
            echo "artifact_name=$zipName" >> $env:GITHUB_OUTPUT
            echo "has_artifact=true" >> $env:GITHUB_OUTPUT
            Write-Host "Created: $zipName" -ForegroundColor Green
          } else {
            echo "has_artifact=false" >> $env:GITHUB_OUTPUT
            Write-Host "Warning: No build output found" -ForegroundColor Yellow
          }

      - name: Upload artifact
        if: steps.prepare.outputs.has_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: PixlPunkt-Skia-Windows-x64
          path: ${{ steps.prepare.outputs.artifact_name }}
          retention-days: 30

  #############################################################################
  # Build WinAppSdk - Windows Native (x64)
  #############################################################################
  build-winappsdk:
    name: WinAppSdk Windows (x64)
    runs-on: windows-latest
    needs: run-tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build WinAppSdk
        shell: pwsh
        run: |
          Write-Host "Building WinAppSdk Windows (x64)..." -ForegroundColor Cyan
          
          # Use WinAppSdkOnly=true to avoid needing Android/iOS workloads
          dotnet publish ${{ env.UNO_PROJECT_PATH }} `
            --configuration Release `
            --framework net10.0-windows10.0.26100 `
            --runtime win-x64 `
            --self-contained true `
            --output ./publish/winappsdk-x64 `
            -p:WinAppSdkOnly=true `
            -p:PublishSingleFile=false `
            -p:PublishReadyToRun=true `
            -p:WindowsPackageType=None

      - name: Prepare artifact
        id: prepare
        shell: pwsh
        run: |
          $zipName = "PixlPunkt-WinAppSdk-x64.zip"
          
          if (Test-Path "./publish/winappsdk-x64") {
            Compress-Archive -Path "./publish/winappsdk-x64/*" -DestinationPath $zipName
            echo "artifact_name=$zipName" >> $env:GITHUB_OUTPUT
            echo "has_artifact=true" >> $env:GITHUB_OUTPUT
            Write-Host "Created: $zipName" -ForegroundColor Green
          } else {
            echo "has_artifact=false" >> $env:GITHUB_OUTPUT
            Write-Host "Warning: No build output found" -ForegroundColor Yellow
          }

      - name: Upload artifact
        if: steps.prepare.outputs.has_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: PixlPunkt-WinAppSdk-x64
          path: ${{ steps.prepare.outputs.artifact_name }}
          retention-days: 30

  #############################################################################
  # Build Skia Desktop - Linux (x64) - Also works for WSL
  #############################################################################
  build-skia-linux:
    name: Skia Desktop Linux (x64)
    runs-on: ubuntu-latest
    needs: run-tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libfontconfig1-dev

      - name: Build Skia Desktop Linux
        run: |
          echo "Building Skia Desktop Linux (x64)..."
          
          # Use SkiaOnly=true to avoid needing Android/iOS workloads
          dotnet publish ${{ env.UNO_PROJECT_PATH }} \
            --configuration Release \
            --framework net10.0-desktop \
            --runtime linux-x64 \
            --self-contained true \
            --output ./publish/skia-linux-x64 \
            -p:SkiaOnly=true \
            -p:PublishSingleFile=false \
            -p:PublishReadyToRun=true

      - name: Prepare artifact
        id: prepare
        run: |
          TAR_NAME="PixlPunkt-Skia-Linux-x64.tar.gz"
          
          if [ -d "./publish/skia-linux-x64" ]; then
            # Make executable
            chmod +x ./publish/skia-linux-x64/PixlPunkt.Uno || true
            
            # Create tarball
            cd ./publish
            tar -czvf ../$TAR_NAME skia-linux-x64
            cd ..
            echo "artifact_name=$TAR_NAME" >> $GITHUB_OUTPUT
            echo "has_artifact=true" >> $GITHUB_OUTPUT
            echo "Created: $TAR_NAME"
          else
            echo "has_artifact=false" >> $GITHUB_OUTPUT
            echo "Warning: No build output found"
          fi

      - name: Upload artifact
        if: steps.prepare.outputs.has_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: PixlPunkt-Skia-Linux-x64
          path: ${{ steps.prepare.outputs.artifact_name }}
          retention-days: 30

  #############################################################################
  # Build Skia Desktop - macOS (x64 and ARM64)
  #############################################################################
  build-skia-macos:
    name: Skia Desktop macOS (${{ matrix.arch }})
    runs-on: macos-latest
    needs: run-tests
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
        include:
          - arch: x64
            rid: osx-x64
          - arch: arm64
            rid: osx-arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build Skia Desktop macOS
        run: |
          echo "Building Skia Desktop macOS (${{ matrix.arch }})..."
          
          # Use SkiaOnly=true to avoid needing Android/iOS workloads
          dotnet publish ${{ env.UNO_PROJECT_PATH }} \
            --configuration Release \
            --framework net10.0-desktop \
            --runtime ${{ matrix.rid }} \
            --self-contained true \
            --output ./publish/skia-macos-${{ matrix.arch }} \
            -p:SkiaOnly=true \
            -p:PublishSingleFile=false \
            -p:PublishReadyToRun=true

      - name: Prepare artifact
        id: prepare
        run: |
          ARCH="${{ matrix.arch }}"
          ZIP_NAME="PixlPunkt-Skia-macOS-$ARCH.zip"
          
          if [ -d "./publish/skia-macos-$ARCH" ]; then
            # Make executable
            chmod +x ./publish/skia-macos-$ARCH/PixlPunkt.Uno || true
            
            # Create ZIP
            cd ./publish
            zip -r ../$ZIP_NAME skia-macos-$ARCH
            cd ..
            echo "artifact_name=$ZIP_NAME" >> $GITHUB_OUTPUT
            echo "has_artifact=true" >> $GITHUB_OUTPUT
            echo "Created: $ZIP_NAME"
          else
            echo "has_artifact=false" >> $GITHUB_OUTPUT
            echo "Warning: No build output found"
          fi

      - name: Upload artifact
        if: steps.prepare.outputs.has_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: PixlPunkt-Skia-macOS-${{ matrix.arch }}
          path: ${{ steps.prepare.outputs.artifact_name }}
          retention-days: 30

  #############################################################################
  # Combine All Desktop Artifacts
  #############################################################################
  combine-artifacts:
    name: Combine All Desktop Artifacts
    runs-on: ubuntu-latest
    needs: [run-tests, build-skia-windows, build-winappsdk, build-skia-linux, build-skia-macos]
    if: always() && !cancelled()

    steps:
      - name: Download Skia Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: PixlPunkt-Skia-Windows-x64
          path: ./release
        continue-on-error: true

      - name: Download WinAppSdk artifact
        uses: actions/download-artifact@v4
        with:
          name: PixlPunkt-WinAppSdk-x64
          path: ./release
        continue-on-error: true

      - name: Download Skia Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: PixlPunkt-Skia-Linux-x64
          path: ./release
        continue-on-error: true

      - name: Download Skia macOS x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: PixlPunkt-Skia-macOS-x64
          path: ./release
        continue-on-error: true

      - name: Download Skia macOS arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: PixlPunkt-Skia-macOS-arm64
          path: ./release
        continue-on-error: true

      - name: List all artifacts
        run: |
          echo "=== Combined Release Artifacts ==="
          ls -lah ./release/ 2>/dev/null || echo "No artifacts found"
          echo ""
          echo "=== Summary ==="
          echo "Skia Windows:    $([ -f ./release/PixlPunkt-Skia-Windows-x64.zip ] && echo '?' || echo '?')"
          echo "WinAppSdk:       $([ -f ./release/PixlPunkt-WinAppSdk-x64.zip ] && echo '?' || echo '?')"
          echo "Skia Linux:      $([ -f ./release/PixlPunkt-Skia-Linux-x64.tar.gz ] && echo '?' || echo '?')"
          echo "Skia macOS x64:  $([ -f ./release/PixlPunkt-Skia-macOS-x64.zip ] && echo '?' || echo '?')"
          echo "Skia macOS arm64:$([ -f ./release/PixlPunkt-Skia-macOS-arm64.zip ] && echo '?' || echo '?')"

      - name: Upload combined release
        uses: actions/upload-artifact@v4
        with:
          name: PixlPunkt-Desktop-AllPlatforms
          path: ./release/
          retention-days: 30
          if-no-files-found: warn
