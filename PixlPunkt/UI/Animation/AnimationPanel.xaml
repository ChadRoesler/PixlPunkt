<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="PixlPunkt.UI.Animation.AnimationPanel"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ic="using:FluentIcons.WinUI"
    xmlns:local="using:PixlPunkt.UI.Animation">

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header with mode tabs -->
        <Grid Grid.Row="0" 
              Background="{ThemeResource SolidBackgroundFillColorBaseBrush}"
              Padding="8,4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal" Spacing="4">
                <RadioButton x:Name="TileModeButton"
                             Content="Tile Animation"
                             GroupName="AnimationMode"
                             IsChecked="True"
                             Click="TileModeButton_Click"/>
                <RadioButton x:Name="CanvasModeButton"
                             Content="Canvas Animation"
                             GroupName="AnimationMode"
                             Click="CanvasModeButton_Click"/>
            </StackPanel>

            <TextBlock Grid.Column="1" 
                       Text="Animation"
                       FontWeight="SemiBold"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"
                       Opacity="0.6"/>

            <Button Grid.Column="2"
                    x:Name="SettingsButton"
                    Background="Transparent"
                    Padding="4"
                    ToolTipService.ToolTip="Animation Settings">
                <ic:FluentIcon Icon="Settings" FontSize="16"/>
                <Button.Flyout>
                    <Flyout x:Name="AnimationSettingsFlyout" Placement="Bottom">
                        <StackPanel Spacing="12" Width="280">
                            <TextBlock Text="Animation Settings" FontWeight="SemiBold" FontSize="14"/>
                            
                            <!-- Keyframe Settings -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="Keyframes" FontSize="12" Opacity="0.7"/>
                                
                                <ToggleSwitch x:Name="AutoKeyframeToggle" 
                                              Header="Auto-create Keyframes" 
                                              Toggled="AutoKeyframe_Toggled"/>
                                <TextBlock Text="When enabled, painting on an animated layer automatically creates a keyframe at the current frame." 
                                           FontSize="10" 
                                           Opacity="0.5" 
                                           TextWrapping="Wrap" 
                                           Margin="0,-4,0,0"/>
                            </StackPanel>
                            
                            <MenuFlyoutSeparator/>
                            
                            <!-- Playback Settings -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="Playback" FontSize="12" Opacity="0.7"/>
                                
                                <ToggleSwitch x:Name="PingPongToggle" 
                                              Header="Ping-Pong (Reverse at End)" 
                                              Toggled="PingPong_Toggled"/>
                            </StackPanel>
                            
                            <MenuFlyoutSeparator/>
                            
                            <!-- Onion Skin Settings -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="Onion Skinning" FontSize="12" Opacity="0.7"/>
                                
                                <ToggleSwitch x:Name="OnionSkinEnabledToggle" 
                                              Header="Enable Onion Skin" 
                                              Toggled="OnionSkinEnabled_Toggled"/>
                                
                                <Grid ColumnSpacing="8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <NumberBox x:Name="OnionSkinBeforeBox" 
                                               Header="Frames Before" 
                                               Minimum="0" Maximum="10" 
                                               Value="2"
                                               SpinButtonPlacementMode="Compact"
                                               ValueChanged="OnionSkinBefore_ValueChanged"/>
                                    <NumberBox x:Name="OnionSkinAfterBox" 
                                               Header="Frames After" 
                                               Grid.Column="1"
                                               Minimum="0" Maximum="10" 
                                               Value="1"
                                               SpinButtonPlacementMode="Compact"
                                               ValueChanged="OnionSkinAfter_ValueChanged"/>
                                </Grid>
                                

                                <Slider x:Name="OnionSkinOpacitySlider"
                                        Header="Opacity"
                                        Minimum="0" Maximum="100" Value="30"
                                        ValueChanged="OnionSkinOpacity_ValueChanged"/>
                            </StackPanel>
                            
                            <MenuFlyoutSeparator/>
                            
                            <!-- Timeline Settings -->
                            <StackPanel Spacing="8">
                                <TextBlock Text="Timeline" FontSize="12" Opacity="0.7"/>
                                
                                <ToggleSwitch x:Name="AutoScrollPlayheadToggle" 
                                              Header="Auto-scroll with Playhead" 
                                              IsOn="True"
                                              Toggled="AutoScrollPlayhead_Toggled"/>
                            </StackPanel>
                        </StackPanel>
                    </Flyout>
                </Button.Flyout>
            </Button>
        </Grid>

        <!-- Tile Animation Mode Content -->
        <Grid x:Name="TileAnimationContent" 
              Grid.Row="1"
              Visibility="Visible">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="180" MinWidth="120"/>
                <ColumnDefinition Width="6"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="6"/>
                <ColumnDefinition Width="200" MinWidth="150"/>
            </Grid.ColumnDefinitions>

            <local:ReelListPanel x:Name="ReelList" Grid.Column="0"/>

            <Border Grid.Column="1" 
                    Width="6"
                    HorizontalAlignment="Stretch"
                    Background="{ThemeResource SolidBackgroundFillColorBaseBrush}"/>

            <local:FrameEditPanel x:Name="FrameEditor" Grid.Column="2"/>

            <Border Grid.Column="3" 
                    Width="6"
                    HorizontalAlignment="Stretch"
                    Background="{ThemeResource SolidBackgroundFillColorBaseBrush}"/>

            <local:PlaybackPanel x:Name="Playback" Grid.Column="4"/>
        </Grid>

        <!-- Canvas Animation Mode Content -->
        <Grid x:Name="CanvasAnimationContent" 
              Grid.Row="1"
              Visibility="Collapsed">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition x:Name="StagePreviewSplitterColumn" Width="6"/>
                <ColumnDefinition x:Name="StagePreviewColumn" Width="200" MinWidth="150"/>
            </Grid.ColumnDefinitions>

            <!-- Canvas Animation Toolbar -->
            <Grid Grid.Row="0" Grid.ColumnSpan="3" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}" Padding="8,4">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Playback Controls -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="2">
                    <Button Click="CanvasFirstFrame_Click" Padding="4" Background="Transparent">
                        <ic:FluentIcon Icon="Previous" FontSize="14"/>
                    </Button>
                    <Button Click="CanvasPrevFrame_Click" Padding="4" Background="Transparent">
                        <ic:FluentIcon Icon="ChevronLeft" FontSize="14"/>
                    </Button>
                    <Button Click="CanvasPlayPause_Click" Padding="4" Background="Transparent">
                        <ic:FluentIcon x:Name="CanvasPlayPauseIcon" Icon="Play" FontSize="14"/>
                    </Button>
                    <Button Click="CanvasStop_Click" Padding="4" Background="Transparent">
                        <ic:FluentIcon Icon="Stop" FontSize="14"/>
                    </Button>
                    <Button Click="CanvasNextFrame_Click" Padding="4" Background="Transparent">
                        <ic:FluentIcon Icon="ChevronRight" FontSize="14"/>
                    </Button>
                    <Button Click="CanvasLastFrame_Click" Padding="4" Background="Transparent">
                        <ic:FluentIcon Icon="Next" FontSize="14"/>
                    </Button>
                </StackPanel>

                <!-- Frame Display -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" Margin="12,0">
                    <TextBlock Text="Frame:" VerticalAlignment="Center" FontSize="11" Opacity="0.7"/>
                    <NumberBox x:Name="CanvasFrameNumberBox" Value="0" Minimum="0" SpinButtonPlacementMode="Compact" Width="80" ValueChanged="CanvasFrameNumber_ValueChanged"/>
                    <TextBlock Text="/" VerticalAlignment="Center" Opacity="0.5"/>
                    <NumberBox x:Name="CanvasTotalFramesBox" Value="24" Minimum="1" Maximum="9999" SpinButtonPlacementMode="Compact" Width="80" ValueChanged="CanvasTotalFrames_ValueChanged"/>
                </StackPanel>

                <!-- Keyframe Operations -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="2" Margin="12,0">
                    <Button Click="CanvasAddKeyframe_Click" Padding="4" Background="Transparent" ToolTipService.ToolTip="Add Keyframe">
                        <StackPanel Orientation="Horizontal" Spacing="2">
                            <ic:FluentIcon Icon="KeyboardShiftUppercase" FontSize="12"/>
                            <TextBlock Text="+" FontSize="12" FontWeight="Bold"/>
                        </StackPanel>
                    </Button>
                    <Button Click="CanvasRemoveKeyframe_Click" Padding="4" Background="Transparent" ToolTipService.ToolTip="Remove Keyframe">
                        <StackPanel Orientation="Horizontal" Spacing="2">
                            <ic:FluentIcon Icon="KeyboardShiftUppercase" FontSize="12"/>
                            <TextBlock Text="-" FontSize="12" FontWeight="Bold"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Stage Controls -->
                <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="4" Margin="12,0">
                    <ToggleButton x:Name="StageEnabledToggle" Click="StageEnabled_Click" ToolTipService.ToolTip="Enable Stage (Camera)">
                        <ic:FluentIcon Icon="VideoClip" FontSize="14"/>
                    </ToggleButton>
                    <!-- Quick Add Stage Keyframe button (only visible when stage is enabled) -->
                    <Button x:Name="StageAddKeyframeQuickButton" 
                            Click="StageAddKeyframeQuick_Click" 
                            Padding="4" 
                            Background="Transparent" 
                            ToolTipService.ToolTip="Add Stage Keyframe at Current Frame"
                            Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal" Spacing="2">
                            <ic:FluentIcon Icon="Camera" FontSize="12"/>
                            <TextBlock Text="+" FontSize="10" FontWeight="Bold" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <!-- Quick Remove Stage Keyframe button (only visible when stage is enabled) -->
                    <Button x:Name="StageRemoveKeyframeQuickButton" 
                            Click="StageRemoveKeyframeQuick_Click" 
                            Padding="4" 
                            Background="Transparent" 
                            ToolTipService.ToolTip="Remove Stage Keyframe at Current Frame"
                            Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal" Spacing="2">
                            <ic:FluentIcon Icon="Camera" FontSize="12"/>
                            <TextBlock Text="-" FontSize="10" FontWeight="Bold" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="StageSettingsButton" Click="StageSettings_Click" Padding="4" Background="Transparent" ToolTipService.ToolTip="Stage Settings">
                        <ic:FluentIcon Icon="CameraSwitch" FontSize="14"/>
                        <Button.Flyout>
                            <Flyout x:Name="StageSettingsFlyout" Placement="Bottom">
                                <StackPanel Spacing="12" Width="280">
                                    <TextBlock Text="Stage (Camera) Settings" FontWeight="SemiBold" FontSize="14"/>
                                    
                                    <!-- Stage Dimensions -->
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Stage Area (within canvas)" FontSize="11" Opacity="0.7"/>
                                        <Grid ColumnSpacing="8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <NumberBox x:Name="StageXBox" Header="X" Minimum="0" SpinButtonPlacementMode="Compact" ValueChanged="StageX_ValueChanged"/>
                                            <NumberBox x:Name="StageYBox" Header="Y" Grid.Column="1" Minimum="0" SpinButtonPlacementMode="Compact" ValueChanged="StageY_ValueChanged"/>
                                            <NumberBox x:Name="StageWidthBox" Header="Width" Grid.Row="1" Minimum="1" SpinButtonPlacementMode="Compact" ValueChanged="StageWidth_ValueChanged"/>
                                            <NumberBox x:Name="StageHeightBox" Header="Height" Grid.Row="1" Grid.Column="1" Minimum="1" SpinButtonPlacementMode="Compact" ValueChanged="StageHeight_ValueChanged"/>
                                        </Grid>
                                    </StackPanel>

                                    <!-- Output Dimensions -->
                                    <StackPanel Spacing="4">
                                        <TextBlock Text="Output Dimensions" FontSize="11" Opacity="0.7"/>
                                        <Grid ColumnSpacing="8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <NumberBox x:Name="StageOutputWidthBox" Header="Width" Minimum="1" SpinButtonPlacementMode="Compact" ValueChanged="StageOutputWidth_ValueChanged"/>
                                            <NumberBox x:Name="StageOutputHeightBox" Header="Height" Grid.Column="1" Minimum="1" SpinButtonPlacementMode="Compact" ValueChanged="StageOutputHeight_ValueChanged"/>
                                        </Grid>
                                    </StackPanel>

                                    <!-- Scaling Algorithm -->
                                    <ComboBox x:Name="StageScalingCombo" Header="Scaling Algorithm" SelectionChanged="StageScaling_SelectionChanged" HorizontalAlignment="Stretch">
                                        <ComboBoxItem Content="Nearest Neighbor (Pixel Art)" Tag="NearestNeighbor"/>
                                        <ComboBoxItem Content="Bilinear (Smooth)" Tag="Bilinear"/>
                                        <ComboBoxItem Content="Bicubic (High Quality)" Tag="Bicubic"/>
                                    </ComboBox>

                                    <!-- Bounds Mode -->
                                    <ComboBox x:Name="StageBoundsCombo" Header="Bounds Mode" SelectionChanged="StageBounds_SelectionChanged" HorizontalAlignment="Stretch">
                                        <ComboBoxItem Content="Free (Can go outside)" Tag="Free"/>
                                        <ComboBoxItem Content="Constrained (Stay in canvas)" Tag="Constrained"/>
                                        <ComboBoxItem Content="Center Locked" Tag="CenterLocked"/>
                                    </ComboBox>

                                    <!-- Match Canvas Button -->
                                    <Button Content="Match Canvas Size" Click="StageMatchCanvas_Click" HorizontalAlignment="Stretch"/>

                                    <!-- Stage Keyframe -->
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <Button Content="Add Stage Keyframe" Click="StageAddKeyframe_Click"/>
                                        <Button Content="Remove" Click="StageRemoveKeyframe_Click"/>
                                    </StackPanel>
                                </StackPanel>
                            </Flyout>
                        </Button.Flyout>
                    </Button>
                </StackPanel>

                <!-- Audio Controls -->
                <StackPanel Grid.Column="4" Orientation="Horizontal" Spacing="4" Margin="12,0">
                    <Button x:Name="AudioLoadButton" Click="AudioLoad_Click" Padding="4" Background="Transparent" ToolTipService.ToolTip="Load Audio Track">
                        <ic:FluentIcon Icon="MusicNote1" FontSize="14"/>
                    </Button>
                    <ToggleButton x:Name="AudioMuteToggle" Click="AudioMute_Click" ToolTipService.ToolTip="Mute Audio">
                        <ic:FluentIcon x:Name="AudioMuteIcon" Icon="Speaker2" FontSize="14"/>
                    </ToggleButton>
                    <Slider x:Name="AudioVolumeSlider" 
                            Minimum="0" Maximum="100" Value="100" 
                            Width="80" 
                            VerticalAlignment="Center"
                            ValueChanged="AudioVolume_ValueChanged"
                            ToolTipService.ToolTip="Audio Volume"/>
                    <Button x:Name="AudioRemoveButton" Click="AudioRemove_Click" Padding="4" Background="Transparent" ToolTipService.ToolTip="Remove Audio Track" Visibility="Collapsed">
                        <ic:FluentIcon Icon="Delete" FontSize="14"/>
                    </Button>
                </StackPanel>

                <Border Grid.Column="5"/>

                <!-- FPS Control -->
                <StackPanel Grid.Column="6" Orientation="Horizontal" Spacing="4" Margin="12,0">
                    <TextBlock Text="FPS:" VerticalAlignment="Center" FontSize="11" Opacity="0.7"/>
                    <NumberBox x:Name="CanvasFpsBox" Value="12" Minimum="1" Maximum="60" SpinButtonPlacementMode="Compact" Width="70" ValueChanged="CanvasFps_ValueChanged"/>
                </StackPanel>

                <!-- Loop & Options -->
                <StackPanel Grid.Column="7" Orientation="Horizontal" Spacing="4">
                    <ToggleButton x:Name="CanvasLoopToggle" IsChecked="True" Click="CanvasLoop_Click" ToolTipService.ToolTip="Loop Animation">
                        <ic:FluentIcon Icon="ArrowRepeatAll" FontSize="14"/>
                    </ToggleButton>
                    <ToggleButton x:Name="CanvasOnionSkinToggle" Click="CanvasOnionSkin_Click" ToolTipService.ToolTip="Onion Skinning">
                        <ic:FluentIcon Icon="LayerDiagonal" FontSize="14"/>
                    </ToggleButton>
                </StackPanel>
            </Grid>

            <!-- Timeline Area -->
            <Grid Grid.Row="1" Grid.Column="0" Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="28"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="150"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Headers -->
                <Border Grid.Row="0" Grid.Column="0" 
                        BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}" 
                        BorderThickness="0,0,1,1"
                        Background="{ThemeResource SolidBackgroundFillColorBaseBrush}">
                    <TextBlock Text="Layers" VerticalAlignment="Center" HorizontalAlignment="Center" FontSize="11" Opacity="0.7"/>
                </Border>

                <!-- Frame Numbers Header -->
                <ScrollViewer x:Name="CanvasHeaderScrollViewer" Grid.Row="0" Grid.Column="1"
                              HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled"
                              Background="{ThemeResource SolidBackgroundFillColorBaseBrush}">
                    <StackPanel x:Name="CanvasFrameNumbersPanel" Orientation="Horizontal"/>
                </ScrollViewer>

                <!-- Layer Names -->
                <ScrollViewer x:Name="CanvasLayerNamesScrollViewer" Grid.Row="1" Grid.Column="0"
                              HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Hidden"
                              BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                              BorderThickness="0,0,1,0">
                    <StackPanel x:Name="CanvasLayerNamesPanel" Orientation="Vertical"/>
                </ScrollViewer>

                <!-- Keyframe Grid with Playhead -->
                <Grid Grid.Row="1" Grid.Column="1">
                    <ScrollViewer x:Name="CanvasKeyframeScrollViewer"
                                  HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto"
                                  HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                                  ViewChanged="CanvasKeyframeGrid_ViewChanged">
                        <Canvas x:Name="CanvasKeyframeCanvas"
                                HorizontalAlignment="Left" VerticalAlignment="Top"
                                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                PointerPressed="CanvasKeyframeCanvas_PointerPressed"
                                PointerMoved="CanvasKeyframeCanvas_PointerMoved"
                                PointerReleased="CanvasKeyframeCanvas_PointerReleased"
                                RightTapped="CanvasKeyframeCanvas_RightTapped">
                            <Canvas.ContextFlyout>
                                <MenuFlyout x:Name="KeyframeContextMenu">
                                    <MenuFlyoutItem x:Name="KeyframeContextAdd" Text="Add Keyframe" Click="KeyframeContext_AddKeyframe">
                                        <MenuFlyoutItem.Icon>
                                            <ic:FluentIcon Icon="Add"/>
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                    <MenuFlyoutItem x:Name="KeyframeContextRemove" Text="Remove Keyframe" Click="KeyframeContext_RemoveKeyframe">
                                        <MenuFlyoutItem.Icon>
                                            <ic:FluentIcon Icon="Delete"/>
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                    <MenuFlyoutSeparator/>
                                    <MenuFlyoutItem x:Name="KeyframeContextCopy" Text="Copy Keyframe" Click="KeyframeContext_CopyKeyframe">
                                        <MenuFlyoutItem.Icon>
                                            <ic:FluentIcon Icon="Copy"/>
                                        </MenuFlyoutItem.Icon>
                                        <MenuFlyoutItem.KeyboardAcceleratorTextOverride>Ctrl+C</MenuFlyoutItem.KeyboardAcceleratorTextOverride>
                                    </MenuFlyoutItem>
                                    <MenuFlyoutItem x:Name="KeyframeContextCut" Text="Cut Keyframe" Click="KeyframeContext_CutKeyframe">
                                        <MenuFlyoutItem.Icon>
                                            <ic:FluentIcon Icon="Cut"/>
                                        </MenuFlyoutItem.Icon>
                                        <MenuFlyoutItem.KeyboardAcceleratorTextOverride>Ctrl+X</MenuFlyoutItem.KeyboardAcceleratorTextOverride>
                                    </MenuFlyoutItem>
                                    <MenuFlyoutItem x:Name="KeyframeContextPaste" Text="Paste Keyframe" Click="KeyframeContext_PasteKeyframe">
                                        <MenuFlyoutItem.Icon>
                                            <ic:FluentIcon Icon="ClipboardPaste"/>
                                        </MenuFlyoutItem.Icon>
                                        <MenuFlyoutItem.KeyboardAcceleratorTextOverride>Ctrl+V</MenuFlyoutItem.KeyboardAcceleratorTextOverride>
                                    </MenuFlyoutItem>
                                    <MenuFlyoutSeparator/>
                                    <MenuFlyoutItem x:Name="KeyframeContextMoveLeft" Text="Move Keyframe Left" Click="KeyframeContext_MoveKeyframeLeft">
                                        <MenuFlyoutItem.Icon>
                                            <ic:FluentIcon Icon="ChevronLeft"/>
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                    <MenuFlyoutItem x:Name="KeyframeContextMoveRight" Text="Move Keyframe Right" Click="KeyframeContext_MoveKeyframeRight">
                                        <MenuFlyoutItem.Icon>
                                            <ic:FluentIcon Icon="ChevronRight"/>
                                        </MenuFlyoutItem.Icon>
                                    </MenuFlyoutItem>
                                </MenuFlyout>
                            </Canvas.ContextFlyout>
                        </Canvas>
                    </ScrollViewer>
                    <!-- Playhead overlay -->
                    <Canvas x:Name="CanvasPlayheadCanvas" IsHitTestVisible="False"
                            HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <Rectangle x:Name="CanvasPlayheadLine" Width="2" Fill="{ThemeResource AccentFillColorDefaultBrush}"/>
                    </Canvas>
                </Grid>
            </Grid>

            <!-- Splitter between Timeline and Stage Preview -->
            <Border x:Name="StagePreviewSplitter" 
                    Grid.Row="1" Grid.Column="1" 
                    Width="6"
                    HorizontalAlignment="Stretch"
                    Background="{ThemeResource SolidBackgroundFillColorBaseBrush}"/>

            <!-- Stage Preview Panel (wrapped in a card-style container with undock button) -->
            <Grid x:Name="StagePreviewContainer" Grid.Row="1" Grid.Column="2">
                <!-- Header with undock button -->
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- Header bar -->
                <Border Grid.Row="0"
                        Padding="8,4"
                        Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="0,0,0,1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <ic:FluentIcon Icon="VideoClip" FontSize="12" Opacity="0.7"/>
                            <TextBlock Text="Animation Preview" 
                                       FontSize="11" 
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                        
                        <Button x:Name="StagePreviewUndockButton"
                                Grid.Column="1"
                                Click="StagePreviewUndock_Click"
                                Padding="4"
                                Background="Transparent"
                                ToolTipService.ToolTip="Undock to separate window">
                            <ic:FluentIcon x:Name="StagePreviewUndockIcon" Icon="Open" FontSize="12"/>
                        </Button>
                    </Grid>
                </Border>
                
                <!-- The actual stage preview panel -->
                <local:StagePreviewPanel x:Name="StagePreview" Grid.Row="1"/>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
