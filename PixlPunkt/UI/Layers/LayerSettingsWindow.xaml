<!--
    LayerSettingsWindow
    Provides UI for editing a layer's core properties (name, opacity, blend mode, visibility/lock/solo)
    and configuring per-layer post-processing effects.
-->
<Window
    x:Class="PixlPunkt.UI.Layers.LayerSettingsWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ic="using:FluentIcons.WinUI"
    xmlns:conv="using:PixlPunkt.UI.Converters"
    xmlns:sdk="using:PixlPunkt.PluginSdk.Compositing"
    xmlns:layerUi="using:PixlPunkt.UI.Layers">

    <!-- Root layout container -->
    <Grid x:Name="Root"
          Padding="16"
          RowSpacing="14"
          ColumnSpacing="12"
          Background="{ThemeResource SolidBackgroundFillColorBaseBrush}">

        <!-- ========== RESOURCES ========== -->
        <Grid.Resources>

            <!-- Converters -->
            <conv:ByteToDoubleConverter x:Key="ByteToDouble" />
            <conv:BoolToVisibilityConverter x:Key="BoolToVis" />
            <conv:InverseBoolToVisibilityConverter x:Key="NotBoolToVis" />

            <!-- Styles -->
            <Style x:Key="SlimListViewItemStyle" TargetType="ListViewItem">
                <Setter Property="MinHeight" Value="28" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                <Setter Property="VerticalContentAlignment" Value="Stretch" />
                <Setter Property="Margin" Value="0" />
            </Style>
        </Grid.Resources>

        <!-- Grid layout definition -->
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <!-- Main content -->
            <RowDefinition Height="Auto" />
            <!-- Footer -->
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <!-- Left panel: layer properties -->
            <ColumnDefinition Width="*" />
            <!-- Right panel: effects list/editor -->
        </Grid.ColumnDefinitions>

        <!-- ========== LEFT PANEL: BASE LAYER PROPERTIES ========== -->
        <Grid Grid.Row="0"
              Grid.Column="0"
              RowSpacing="14"
              ColumnSpacing="12">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <!-- Name -->
                <RowDefinition Height="Auto" />
                <!-- Opacity -->
                <RowDefinition Height="Auto" />
                <!-- Blend mode -->
                <RowDefinition Height="Auto" />
                <!-- Toggles -->
                <RowDefinition Height="*" />
                <!-- Spacer / future content -->
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <!-- Labels -->
                <ColumnDefinition Width="*" />
                <!-- Inputs -->
                <ColumnDefinition Width="Auto" />
                <!-- Secondary input -->
            </Grid.ColumnDefinitions>

            <!-- Layer name -->
            <TextBlock Grid.Row="0"
                       Grid.Column="0"
                       Margin="0,2,8,0"
                       Text="Name:"
                       VerticalAlignment="Center"
                       MaxWidth="100" />
            <TextBox x:Name="NameBox"
                     Grid.Row="0"
                     Grid.Column="1"
                     Grid.ColumnSpan="2"
                     Text="{Binding EditableName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <!-- Opacity (0-255 mapped via converter) -->
            <TextBlock Grid.Row="1"
                       Grid.Column="0"
                       Margin="0,2,8,0"
                       Text="Opacity:"
                       VerticalAlignment="Center" />
            <Slider x:Name="OpacitySlider"
                    Grid.Row="1"
                    Grid.Column="1"
                    Minimum="0"
                    Maximum="255"
                    Value="{Binding Layer.Opacity, Mode=TwoWay, Converter={StaticResource ByteToDouble}}"
                    ValueChanged="Opacity_ValueChanged" />
            <NumberBox x:Name="OpacityBox"
                       Grid.Row="1"
                       Grid.Column="2"
                       Minimum="0"
                       Maximum="255"
                       Width="64"
                       Value="{Binding Layer.Opacity, Mode=TwoWay, Converter={StaticResource ByteToDouble}}"
                       ValueChanged="Opacity_ValueChanged" />

            <!-- Blend mode selection -->
            <TextBlock Grid.Row="2"
                       Grid.Column="0"
                       Margin="0,2,8,0"
                       Text="Blend Mode:"
                       VerticalAlignment="Center" />
            <ComboBox x:Name="BlendCombo"
                      Grid.Row="2"
                      Grid.Column="1"
                      Grid.ColumnSpan="2"
                      Width="240"
                      ItemsSource="{Binding BlendModes, Mode=OneTime}"
                      SelectedItem="{Binding Layer.Blend, Mode=TwoWay}"
                      SelectionChanged="BlendCombo_SelectionChanged" />

            <!-- Visibility / Lock / Solo toggles -->
            <StackPanel Grid.Row="3"
                        Grid.Column="1"
                        Orientation="Horizontal"
                        Spacing="12">

                <!-- Visibility toggle -->
                <ToggleButton x:Name="VisBtn"
                              ToolTipService.ToolTip="Visibility"
                              IsChecked="{Binding Layer.Visible, Mode=TwoWay}"
                              Click="VisBtn_Click">
                    <Grid>
                        <ic:FluentIcon Icon="Eye"
                                       Visibility="{Binding IsChecked, ElementName=VisBtn, Converter={StaticResource BoolToVis}}" />
                        <ic:FluentIcon Icon="EyeOff"
                                       Visibility="{Binding IsChecked, ElementName=VisBtn, Converter={StaticResource NotBoolToVis}}" />
                    </Grid>
                </ToggleButton>

                <!-- Lock toggle -->
                <ToggleButton x:Name="LockBtn"
                              ToolTipService.ToolTip="Lock"
                              IsChecked="{Binding Layer.Locked, Mode=TwoWay}"
                              Click="LockBtn_Click">
                    <Grid>
                        <ic:FluentIcon Icon="LockClosed"
                                       Visibility="{Binding IsChecked, ElementName=LockBtn, Converter={StaticResource BoolToVis}}" />
                        <ic:FluentIcon Icon="LockOpen"
                                       Visibility="{Binding IsChecked, ElementName=LockBtn, Converter={StaticResource NotBoolToVis}}" />
                    </Grid>
                </ToggleButton>

                <!-- Solo toggle -->
                <ToggleButton x:Name="SoloBtn"
                              ToolTipService.ToolTip="Solo Layer"
                              Checked="SoloBtn_Checked"
                              Unchecked="SoloBtn_Unchecked">
                    <ic:FluentIcon Icon="EyeTracking" />
                </ToggleButton>
            </StackPanel>
        </Grid>

        <!-- ========== RIGHT PANEL: EFFECTS LIST & EDITORS ========== -->
        <Grid Grid.Row="0"
              Grid.Column="1"
              MinWidth="420">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <TextBlock Grid.Row="0"
                       Text="Effects"
                       FontWeight="SemiBold"
                       Margin="0,0,0,8"/>

            <!-- List of layer effects with dynamic settings UI -->
            <Border x:Name="EffectsBox"
                    Grid.Row="1"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="4">
                <Grid>
                    <ListView x:Name="EffectsList"
                              ItemsSource="{Binding ViewModel.Effects}"
                              SelectionChanged="EffectsList_SelectionChanged"
                              MinHeight="252"
                              MinWidth="410"
                              HorizontalAlignment="Stretch"
                              VerticalAlignment="Stretch"
                              AllowDrop="True"
                              CanDragItems="True"
                              CanReorderItems="False"
                              DragItemsStarting="EffectsList_DragItemsStarting"
                              DragOver="EffectsList_DragOver"
                              Drop="EffectsList_Drop"
                              DragLeave="EffectsList_DragLeave">

                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="Padding" Value="0,0,12,0" />
                                <Setter Property="Margin" Value="0,2" />
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            </Style>
                        </ListView.ItemContainerStyle>
                        
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="sdk:LayerEffectBase">
                                <Expander IsExpanded="{Binding IsEnabled, Mode=OneWay}"
                                          Margin="0"
                                          Padding="0"
                                          MinHeight="0"
                                          HorizontalAlignment="Stretch">
                                    <Expander.Header>
                                        <Grid ColumnSpacing="4"     
                                              MinHeight="24"
                                              Padding="0"
                                              HorizontalAlignment="Stretch"
                                              Background="Transparent">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- Drag handle - this area initiates drag -->
                                            <Border Grid.Column="0" 
                                                    Background="Transparent"
                                                    Padding="4,0"
                                                    VerticalAlignment="Stretch"
                                                    PointerPressed="EffectDragHandle_PointerPressed">
                                                <ic:FluentIcon Icon="ReOrderDotsVertical" Opacity="0.5" VerticalAlignment="Center"/>
                                            </Border>
                                            
                                            <CheckBox Grid.Column="1"
                                                      MinHeight="0"
                                                      MinWidth="0"
                                                      Margin="4,0,0,0"
                                                      IsChecked="{Binding IsEnabled, Mode=TwoWay}"/>
                                            
                                            <TextBlock Grid.Column="2"
                                                       Text="{Binding DisplayName}"
                                                       VerticalAlignment="Center"
                                                       Margin="4,0,0,0"/>

                                            <StackPanel Grid.Column="3"
                                                        Orientation="Horizontal"
                                                        Spacing="2"
                                                        VerticalAlignment="Center">
                                                <Button Tag="{Binding}" Click="EffectMoveUp_Click" Padding="4" MinHeight="0" MinWidth="0">
                                                    <ic:FluentIcon Icon="ArrowCircleUp" FontSize="18" />
                                                </Button>
                                                <Button Tag="{Binding}" Click="EffectMoveDown_Click" Padding="4" MinHeight="0" MinWidth="0">
                                                    <ic:FluentIcon Icon="ArrowCircleDown" FontSize="18" />
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Expander.Header>

                                    <!-- Dynamic content: generated from EffectRegistry.GetOptions() -->
                                    <Expander.Content>
                                        <ContentControl x:Name="EffectOptionsHost"
                                                        DataContext="{Binding}"
                                                        Loaded="EffectOptionsHost_Loaded"/>
                                    </Expander.Content>
                                </Expander>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>

                    <!-- Insertion indicator bar (Photoshop-style) -->
                    <Border x:Name="InsertionIndicator"
                            Height="3"
                            Background="{ThemeResource SystemAccentColor}"
                            CornerRadius="2"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Top"
                            Margin="0"
                            Visibility="Collapsed"
                            IsHitTestVisible="False">
                        <Border.Shadow>
                            <ThemeShadow/>
                        </Border.Shadow>
                    </Border>
                </Grid>
            </Border>
        </Grid>

        <!-- ========== FOOTER ACTIONS ========== -->
        <StackPanel Grid.Row="1"
                    Grid.ColumnSpan="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Spacing="8">
            <Button x:Name="ApplyBtn"
                    Content="Apply"
                    Click="ApplyBtn_Click" />
            <Button x:Name="CloseBtn"
                    Content="Close"
                    Click="CloseBtn_Click" />
        </StackPanel>
    </Grid>
</Window>